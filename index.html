<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>SailRegatta Web</title>
  <!-- OpenLayers desde CDN oficial -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/ol.js"></script>
  <style>
    html, body, #map { 
      height:100%; 
      margin:0; 
      padding:0; 
      width: 100%; /* Añadido para asegurar que ocupe todo el ancho */
    }
    #map { 
      position:fixed; 
      inset:0; 
      background: #aad3df; /* Color de fondo temporal para verificar que el contenedor es visible */
    }
    body { 
      font-family: Arial, sans-serif; 
      background:#000; 
      color:#fff; 
      overflow: hidden; /* Previene barras de desplazamiento */
    }

    .topbar {
      position:fixed; 
      top:10px; 
      left:50%; 
      transform:translateX(-50%);
      background:rgba(20,20,20,0.85); 
      color:#fff;
      padding:6px 12px; 
      border-radius:10px;
      display:flex; 
      gap:10px; 
      align-items:center;
      z-index:2000; 
      box-shadow:0 2px 6px rgba(0,0,0,0.6);
    }
    .side-btn {
      position:fixed; 
      top:50%; 
      transform:translateY(-50%);
      background:rgba(20,20,20,0.85); 
      color:#fff; 
      border:none;
      padding:10px 14px; 
      border-radius:12px;
      font-size:14px; 
      font-weight:600;
      z-index:2000; 
      cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,0.6);
    }
    #leftBtn { left:10px; }
    #rightBtn { right:10px; }
    .side-btn:hover { background:rgba(40,40,40,0.9); }

    #info {
      position:fixed; 
      bottom:12px; 
      left:50%; 
      transform:translateX(-50%);
      background:rgba(20,20,20,0.85); 
      color:#fff;
      padding:8px 14px; 
      border-radius:10px;
      z-index:2000; 
      font-size:14px;
      box-shadow:0 2px 6px rgba(0,0,0,0.6);
      text-align:center;
    }

    .context {
      position:fixed; 
      background:#222; 
      color:#fff;
      border:1px solid #555; 
      padding:8px; 
      border-radius:8px;
      z-index:3000; 
      font-size:14px;
      box-shadow:0 2px 6px rgba(0,0,0,0.6);
    }
    .context button {
      margin:3px; 
      padding:6px 10px;
      background:#333; 
      color:#fff; 
      border:none;
      border-radius:6px; 
      cursor:pointer;
    }
    .context button:hover { background:#555; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <label>Cuenta atrás (min): 
      <input id="countMin" type="number" value="5" min="0" step="1" style="width:60px">
    </label>
    <button id="startTimer">Iniciar</button>
    <button id="pauseTimer">Pausar</button>
    <button id="resetTimer">Reiniciar</button>
    <div id="timerDisplay" style="min-width:80px; text-align:center; font-weight:600;">00:00</div>
  </div>

  <button id="leftBtn" class="side-btn">Babor (coords)</button>
  <button id="rightBtn" class="side-btn">Estribor (coords)</button>

  <div id="info">Distancia a línea: -- m | Tiempo a línea: -- | Diferencia: --</div>

  <script>
  // --- Utilidades ---
  const R = 6378137;
  function lonToX(lon){ return lon * Math.PI/180 * R }
  function latToY(lat){ return Math.log(Math.tan((90+lat)*Math.PI/360)) * R }
  function xyFromLonLat([lon,lat]){ return [lonToX(lon), latToY(lat)] }
  function lonLatFromXY([x,y]){
    const lon = x / R * 180/Math.PI;
    const lat = (2*Math.atan(Math.exp(y/R)) - Math.PI/2) * 180/Math.PI;
    return [lon,lat];
  }
  function pointToSegmentDistance(p, a, b){
    const P=xyFromLonLat(p), A=xyFromLonLat(a), B=xyFromLonLat(b);
    const vx=B[0]-A[0], vy=B[1]-A[1]; const wx=P[0]-A[0], wy=P[1]-A[1];
    const c1 = vx*wx+vy*wy;
    if(c1<=0) return Math.hypot(P[0]-A[0],P[1]-A[1]);
    const c2 = vx*vx+vy*vy;
    if(c2<=c1) return Math.hypot(P[0]-B[0],P[1]-B[1]);
    const t = c1/c2; const projx=A[0]+t*vx, projy=A[1]+t*vy;
    return Math.hypot(P[0]-projx,P[1]-projy);
  }
  function formatSec(s){
    const sign=s<0?'-':''; s=Math.abs(Math.round(s));
    const mm=Math.floor(s/60), ss=s%60;
    return `${sign}${mm}m${String(ss).padStart(2,'0')}s`;
  }

  // --- Mapa ---
  // Asegurarse de que el DOM esté completamente cargado antes de inicializar el mapa
  document.addEventListener('DOMContentLoaded', function() {
    const view = new ol.View({ 
      center: ol.proj.fromLonLat([-3.70379, 40.4168]), // Centrado en Madrid como ejemplo
      zoom: 10 
    });
    
    const map = new ol.Map({
      target: 'map',
      layers: [ 
        new ol.layer.Tile({ 
          source: new ol.source.OSM({
            // Añadir parámetros para evitar problemas de carga de teselas
            crossOrigin: 'anonymous'
          }) 
        }) 
      ],
      view: view,
      // Añadir controles por defecto para mejor usabilidad
      controls: ol.control.defaults().extend([
        new ol.control.Zoom(),
        new ol.control.Rotate(),
        new ol.control.Attribution()
      ])
    });

    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({ source: vectorSource });
    map.addLayer(vectorLayer);

    const shipStyle = new ol.style.Style({ image: new ol.style.Icon({
      src:'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24"><path fill="#0b5" d="M12 2l3 7h-6l3-7z"/><path fill="#064" d="M5 12h14l-1 6H6l-1-6z"/></svg>',
      scale:1.2, rotateWithView:true
    }) });
    const portStyle = new ol.style.Style({ image: new ol.style.Circle({ radius:8, fill:new ol.style.Fill({color:'#ff4d4d'}), stroke:new ol.style.Stroke({color:'#fff',width:2}) }) });
    const starStyle = new ol.style.Style({ image: new ol.style.Circle({ radius:8, fill:new ol.style.Fill({color:'#4da6ff'}), stroke:new ol.style.Stroke({color:'#fff',width:2}) }) });
    const lineStyle = new ol.style.Style({ stroke:new ol.style.Stroke({ color:'#ffbf00', width:4 }) });

    let shipFeature=null, portFeature=null, starFeature=null, lineFeature=null;

    function setShip(lonlat, headingDeg){
      const offsetM = 11; // fijo hacia proa
      let finalLonLat=lonlat;
      if(!isNaN(headingDeg)){
        const theta = headingDeg*Math.PI/180;
        const dx = offsetM * Math.sin(theta); // hacia proa
        const dy = offsetM * Math.cos(theta);
        const XY = xyFromLonLat(lonlat);
        const newXY=[XY[0]+dx, XY[1]+dy];
        finalLonLat=lonLatFromXY(newXY);
      }
      if(!shipFeature){
        shipFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(finalLonLat)));
        shipFeature.setStyle(shipStyle); vectorSource.addFeature(shipFeature);
      } else {
        shipFeature.getGeometry().setCoordinates(ol.proj.fromLonLat(finalLonLat));
      }
      view.animate({ center: ol.proj.fromLonLat(finalLonLat), duration:400 });
    }

    function addPort(lonlat){
      if(portFeature) return;
      portFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(lonlat)));
      portFeature.setStyle(portStyle); vectorSource.addFeature(portFeature); drawLineIfReady();
    }
    function addStar(lonlat){
      if(starFeature) return;
      starFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(lonlat)));
      starFeature.setStyle(starStyle); vectorSource.addFeature(starFeature); drawLineIfReady();
    }
    function drawLineIfReady(){
      if(portFeature && starFeature){
        if(lineFeature) vectorSource.removeFeature(lineFeature);
        const p=portFeature.getGeometry().getCoordinates();
        const s=starFeature.getGeometry().getCoordinates();
        lineFeature=new ol.Feature(new ol.geom.LineString([p,s]));
        lineFeature.setStyle(lineStyle); vectorSource.addFeature(lineFeature);
      }
    }

    // Long press
    let pressTimer=null, pressCoord=null;
    map.getViewport().addEventListener('pointerdown', e=>{
      pressTimer=setTimeout(()=>{
        pressCoord=map.getEventCoordinate(e);
        showContext(e.clientX,e.clientY);
      },600);
    });
    map.getViewport().addEventListener('pointerup',()=>{ if(pressTimer){clearTimeout(pressTimer);pressTimer=null;} });

    function showContext(x,y){
      const menu=document.createElement('div');
      menu.className='context'; menu.style.left=x+'px'; menu.style.top=y+'px';
      menu.innerHTML='<div style="font-weight:600;margin-bottom:6px">Poner marca</div>'+
        '<button id="ctxPort">Babor</button> <button id="ctxStar">Estribor</button><br>'+
        '<button id="ctxClose">Cerrar</button>';
      document.body.appendChild(menu);
      document.getElementById('ctxPort').onclick=()=>{addPort(ol.proj.toLonLat(pressCoord));menu.remove();};
      document.getElementById('ctxStar').onclick=()=>{addStar(ol.proj.toLonLat(pressCoord));menu.remove();};
      document.getElementById('ctxClose').onclick=()=>menu.remove();
    }

    // Botones coordenadas
    document.getElementById('leftBtn').onclick=()=>{
      const lat=parseFloat(prompt('Latitud (dec):'));
      const lon=parseFloat(prompt('Longitud (dec):'));
      if(!isNaN(lat)&&!isNaN(lon)) addPort([lon,lat]);
    };
    document.getElementById('rightBtn').onclick=()=>{
      const lat=parseFloat(prompt('Latitud (dec):'));
      const lon=parseFloat(prompt('Longitud (dec):'));
      if(!isNaN(lat)&&!isNaN(lon)) addStar([lon,lat]);
    };

    // Geolocalización
    let watchId=null;
    const latestState={ position:null, speed:null };
    if('geolocation' in navigator){
      watchId=navigator.geolocation.watchPosition(pos=>{
        const lonlat=[pos.coords.longitude,pos.coords.latitude];
        const heading=pos.coords.heading;
        const speed=pos.coords.speed;
        latestState.position=lonlat; latestState.speed=speed;
        setShip(lonlat, heading!==null?heading:0);
      }, err=>console.warn('GPS err',err), { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
    } else {
      console.warn('Geolocalización no soportada');
      // Establecer una posición por defecto para pruebas
      setShip([-3.70379, 40.4168], 0);
    }

    // Computos
    function computeAndUpdate(){
      const info=document.getElementById('info');
      if(!latestState.position||!portFeature||!starFeature){
        info.innerText='Distancia a línea: -- m | Tiempo a línea: -- | Diferencia: --'; return;
      }
      const p=ol.proj.toLonLat(portFeature.getGeometry().getCoordinates());
      const s=ol.proj.toLonLat(starFeature.getGeometry().getCoordinates());
      const pos=latestState.position;
      const dist=pointToSegmentDistance(pos,p,s);
      const speed=latestState.speed;
      let timeToLine=null; if(speed&&speed>0) timeToLine=dist/speed;
      const remaining=timer.remainingSeconds;
      let diff=null; if(timeToLine!==null) diff=timeToLine-remaining;
      info.innerText=`Distancia: ${dist.toFixed(1)} m | Tiempo: ${timeToLine?formatSec(timeToLine):'--'} | Dif: ${diff!==null?formatSec(diff):'--'}`;
    }
    setInterval(computeAndUpdate,900);

    // Timer
    const timer={ totalSeconds:0, remainingSeconds:0, running:false, interval:null };
    function startTimer(){
      const mins=parseFloat(document.getElementById('countMin').value)||0;
      if(!timer.running){
        if(timer.remainingSeconds<=0) timer.remainingSeconds=Math.round(mins*60);
        timer.running=true;
        timer.interval=setInterval(()=>{
          if(timer.remainingSeconds>0){ timer.remainingSeconds--; updateTimerDisplay(); }
          else{ clearInterval(timer.interval); timer.running=false; }
        },1000);
      }
    }
    function pauseTimer(){ if(timer.running){ clearInterval(timer.interval); timer.running=false; } }
    function resetTimer(){ pauseTimer(); timer.remainingSeconds=Math.round((parseFloat(document.getElementById('countMin').value)||0)*60); updateTimerDisplay(); }
    function updateTimerDisplay(){
      const d=timer.remainingSeconds; const mm=Math.floor(d/60); const ss=d%60;
      document.getElementById('timerDisplay').innerText=`${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }
    document.getElementById('startTimer').onclick=()=>startTimer();
    document.getElementById('pauseTimer').onclick=()=>pauseTimer();
    document.getElementById('resetTimer').onclick=()=>resetTimer();
    resetTimer();

    window.addEventListener('beforeunload',()=>{ if(watchId!==null) navigator.geolocation.clearWatch(watchId); });
  });
  </script>
</body>
</html>
