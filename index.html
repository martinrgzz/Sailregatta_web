<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SailRegatta Web</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
<style>
  html, body, #map { height: 100%; margin:0; }
  #map { position: fixed; inset:0; }
  .topbar{
    position:fixed; top:8px; left:50%; transform:translateX(-50%);
    background:rgba(30,30,30,0.7); color:#fff; padding:6px 12px;
    border-radius:12px; font-family:Arial; display:flex; gap:8px;
    align-items:center; z-index:2000; backdrop-filter:blur(6px);}
  .side-btn{
    position:fixed; top:50%; transform:translateY(-50%);
    background:rgba(30,30,30,0.7); color:#fff; padding:10px 14px;
    border-radius:12px; font-family:Arial; z-index:2000; border:none; cursor:pointer }
  #leftBtn{ left:10px } #rightBtn{ right:10px }
  #nightBtn{ position:fixed; top:8px; right:10px; background:rgba(30,30,30,0.7); color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; z-index:2000; }
  #info{
    position:fixed; bottom:8px; left:50%; transform:translateX(-50%);
    background:rgba(30,30,30,0.8); color:#fff; padding:8px 14px;
    border-radius:12px; z-index:2000; font-family:Arial; font-size:14px; backdrop-filter:blur(6px);}
  .context{
    position:fixed; background:#fff; border:1px solid #ccc; padding:6px;
    border-radius:6px; z-index:3000; font-family:Arial }
  #gpsError{
    position:fixed; bottom:50px; left:50%; transform:translateX(-50%);
    background:rgba(200,0,0,0.8); color:#fff; padding:6px 10px;
    border-radius:8px; font-family:Arial; display:none; z-index:4000; }
  button{ cursor:pointer; border:none; border-radius:6px; padding:4px 8px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="topbar">
  <label>Cuenta atrás (min): <input id="countMin" type="number" value="5" min="0" step="1" style="width:60px"></label>
  <button id="startTimer">Iniciar</button>
  <button id="pauseTimer">Pausar</button>
  <button id="resetTimer">Reiniciar</button>
  <div id="timerDisplay" style="min-width:80px; text-align:center; font-weight:600;">00:00</div>
</div>
<button id="leftBtn" class="side-btn">Babor</button>
<button id="rightBtn" class="side-btn">Estribor</button>
<button id="nightBtn">Modo Noche</button>
<div id="info">Dist: -- m | Tiempo línea: -- | Δ cuenta: --</div>
<div id="gpsError">⚠️ No se pudo acceder al GPS</div>

<script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
<script>
// --- Proyección helpers ---
const R = 6378137;
function lonToX(lon){ return lon * Math.PI/180 * R }
function latToY(lat){ return Math.log(Math.tan((90+lat)*Math.PI/360)) * R }
function xyFromLonLat([lon,lat]){ return [lonToX(lon), latToY(lat)] }
function lonLatFromXY([x,y]){ const lon = x / R * 180/Math.PI; const lat = (2*Math.atan(Math.exp(y/R)) - Math.PI/2) * 180/Math.PI; return [lon,lat] }
function haversine(a,b){ const toR=Math.PI/180; const [lon1,lat1]=a; const [lon2,lat2]=b; const dlat=(lat2-lat1)*toR; const dlon=(lon2-lon1)*toR; const A=Math.sin(dlat/2)**2 + Math.cos(lat1*toR)*Math.cos(lat2*toR)*Math.sin(dlon/2)**2; return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A)); }
function pointToSegmentDistance(p,a,b){ const P=xyFromLonLat(p), A=xyFromLonLat(a), B=xyFromLonLat(b); const vx=B[0]-A[0], vy=B[1]-A[1]; const wx=P[0]-A[0], wy=P[1]-A[1]; const c1=vx*wx+vy*wy; if(c1<=0) return Math.hypot(P[0]-A[0], P[1]-A[1]); const c2=vx*vx+vy*vy; if(c2<=c1) return Math.hypot(P[0]-B[0], P[1]-B[1]); const t=c1/c2; const projx=A[0]+t*vx, projy=A[1]+t*vy; return Math.hypot(P[0]-projx, P[1]-projy); }

// --- Mapas ---
const dayLayer = new ol.layer.Tile({ source: new ol.source.XYZ({ url:'https://cartodb-basemaps-a.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png' }) });
const nightLayer = new ol.layer.Tile({ source: new ol.source.XYZ({ url:'https://cartodb-basemaps-a.global.ssl.fastly.net/rastertiles/dark_all/{z}/{x}/{y}.png' }), visible:false });

const map = new ol.Map({ target:'map', layers:[dayLayer, nightLayer], view:new ol.View({ center: ol.proj.fromLonLat([0,0]), zoom:3 }) });

// --- Vectors ---
const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({ source: vectorSource });
map.addLayer(vectorLayer);

// --- Estilos ---
const shipStyle = new ol.style.Style({
  fill: new ol.style.Fill({ color:'#001f3f' }),
  stroke: new ol.style.Stroke({ color:'#ffffff', width:1 })
});
const headingLineStyle = new ol.style.Style({
  stroke: new ol.style.Stroke({ color:'rgba(0,31,63,0.7)', width:3 })
});
const portStyle = new ol.style.Style({ image: new ol.style.Circle({ radius:8, fill:new ol.style.Fill({color:'#ff4d4d'}), stroke:new ol.style.Stroke({color:'#fff', width:2}) }) });
const starStyle = new ol.style.Style({ image: new ol.style.Circle({ radius:8, fill:new ol.style.Fill({color:'#4da6ff'}), stroke:new ol.style.Stroke({color:'#fff', width:2}) }) });
const lineStyle = new ol.style.Style({ stroke: new ol.style.Stroke({ color:'#ffbf00', width:4 }) });

let shipFeature=null, headingLineFeature=null, portFeature=null, starFeature=null, lineFeature=null;

// --- Barco a escala real ---
function createShipGeometry(lonlat, headingDeg){
  const L = 12;  // largo metros
  const W = 3;   // ancho base
  const theta = headingDeg * Math.PI/180;

  const tip = [ lonToX(lonlat[0]) + L*Math.sin(theta),
                latToY(lonlat[1]) + L*Math.cos(theta) ];
  const left = [ lonToX(lonlat[0]) - (W/2)*Math.cos(theta),
                 latToY(lonlat[1]) + (W/2)*Math.sin(theta) ];
  const right= [ lonToX(lonlat[0]) + (W/2)*Math.cos(theta),
                 latToY(lonlat[1]) - (W/2)*Math.sin(theta) ];

  const tipLL   = lonLatFromXY(tip);
  const leftLL  = lonLatFromXY(left);
  const rightLL = lonLatFromXY(right);

  return new ol.geom.Polygon([[
    ol.proj.fromLonLat(leftLL),
    ol.proj.fromLonLat(tipLL),
    ol.proj.fromLonLat(rightLL),
    ol.proj.fromLonLat(leftLL)
  ]]);
}

function setShip(lonlat, headingDeg){
  if(!shipFeature){
    shipFeature=new ol.Feature();
    shipFeature.setStyle(shipStyle);
    vectorSource.addFeature(shipFeature);
  }
  shipFeature.setGeometry(createShipGeometry(lonlat, headingDeg));

  // Línea de proyección (~2 NM ≈ 3700 m)
  const distanceM = 3700;
  const theta = headingDeg * Math.PI / 180;
  const dx = distanceM * Math.sin(theta);
  const dy = distanceM * Math.cos(theta);
  const XY=[lonToX(lonlat[0])+dx, latToY(lonlat[1])+dy];
  const targetLonLat=lonLatFromXY(XY);

  if(!headingLineFeature){
    headingLineFeature=new ol.Feature(new ol.geom.LineString([
      ol.proj.fromLonLat(lonlat),
      ol.proj.fromLonLat(targetLonLat)
    ]));
    headingLineFeature.setStyle(headingLineStyle);
    vectorSource.addFeature(headingLineFeature);
  } else {
    headingLineFeature.getGeometry().setCoordinates([
      ol.proj.fromLonLat(lonlat),
      ol.proj.fromLonLat(targetLonLat)
    ]);
  }
}

// --- Marcas ---
function addPort(lonlat){ if(portFeature) return; portFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(lonlat)));
  portFeature.setStyle(portStyle); vectorSource.addFeature(portFeature); drawLineIfReady(); }
function addStar(lonlat){ if(starFeature) return; starFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(lonlat)));
  starFeature.setStyle(starStyle); vectorSource.addFeature(starFeature); drawLineIfReady(); }
function drawLineIfReady(){ if(portFeature && starFeature){
  if(lineFeature) vectorSource.removeFeature(lineFeature);
  lineFeature=new ol.Feature(new ol.geom.LineString([portFeature.getGeometry().getCoordinates(), starFeature.getGeometry().getCoordinates()]));
  lineFeature.setStyle(lineStyle); vectorSource.addFeature(lineFeature);
}}

// --- Long press con un dedo ---
let pressTimer=null, pressCoord=null, startPixel=null;
const threshold=5;
map.getViewport().addEventListener('pointerdown', e=>{
  if(e.pointerType==="touch" && e.isPrimary && e.targetTouches?.length<=1){
    startPixel=[e.clientX,e.clientY];
    pressTimer=setTimeout(()=>{
      pressCoord=map.getEventCoordinate(e);
      showContext(e.clientX,e.clientY);
    },600);
  }
});
map.getViewport().addEventListener('pointermove', e=>{
  if(pressTimer){
    const dx=e.clientX-startPixel[0], dy=e.clientY-startPixel[1];
    if(Math.hypot(dx,dy)>threshold){ clearTimeout(pressTimer); pressTimer=null; }
  }
});
map.getViewport().addEventListener('pointerup', ()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } });

function showContext(x,y){
  const feature = map.forEachFeatureAtPixel([x,y], f=>f);
  const menu=document.createElement('div'); menu.className='context'; menu.style.left=x+'px'; menu.style.top=y+'px';
  if(feature===portFeature||feature===starFeature){
    menu.innerHTML='<div style="font-weight:600;margin-bottom:6px">Marca</div><button id="ctxDel">Borrar</button><div style="height:6px"></div><button id="ctxClose">Cerrar</button>';
    document.body.appendChild(menu);
    document.getElementById('ctxDel').onclick=()=>{
      vectorSource.removeFeature(feature);
      if(feature===portFeature) portFeature=null; else starFeature=null;
      if(lineFeature) vectorSource.removeFeature(lineFeature); lineFeature=null;
      menu.remove();
    };
  } else {
    menu.innerHTML='<div style="font-weight:600;margin-bottom:6px">Poner marca</div><button id="ctxPort">Babor</button> <button id="ctxStar">Estribor</button><div style="height:6px"></div><button id="ctxClose">Cerrar</button>';
    document.body.appendChild(menu);
    document.getElementById('ctxPort').onclick=()=>{ addPort(ol.proj.toLonLat(pressCoord)); menu.remove(); };
    document.getElementById('ctxStar').onclick=()=>{ addStar(ol.proj.toLonLat(pressCoord)); menu.remove(); };
  }
  document.getElementById('ctxClose').onclick=()=>menu.remove();
}

// --- Botones coords ---
document.getElementById('leftBtn').onclick=()=>{ const lat=parseFloat(prompt('Latitud (dec):')), lon=parseFloat(prompt('Longitud (dec):')); if(!isNaN(lat)&&!isNaN(lon)) addPort([lon,lat]); };
document.getElementById('rightBtn').onclick=()=>{ const lat=parseFloat(prompt('Latitud (dec):')), lon=parseFloat(prompt('Longitud (dec):')); if(!isNaN(lat)&&!isNaN(lon)) addStar([lon,lat]); };

// --- Modo noche ---
document.getElementById('nightBtn').onclick=()=>{ nightLayer.setVisible(!nightLayer.getVisible()); dayLayer.setVisible(!nightLayer.getVisible()); };

// --- Geolocalización ---
let latestState={ position:null, speed:null, initialCentered:false };
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    document.getElementById('gpsError').style.display="none";
    const lonlat=[pos.coords.longitude,pos.coords.latitude];
    const heading = (pos.coords.heading!==null)?pos.coords.heading:0;
    setShip(lonlat, heading);
    latestState.position=lonlat;
    latestState.speed=pos.coords.speed;
    if(!latestState.initialCentered){ map.getView().animate({ center: ol.proj.fromLonLat(lonlat), zoom:15, duration:800 }); latestState.initialCentered=true; }
  }, ()=>{ document.getElementById('gpsError').style.display="block"; }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
} else { document.getElementById('gpsError').style.display="block"; }

// --- Distancias y tiempo ---
function computeAndUpdate(){
  const info=document.getElementById('info');
  if(!latestState.position||!portFeature||!starFeature){ info.innerText='Dist: -- m | Tiempo línea: -- | Δ cuenta: --'; return; }
  const p=ol.proj.toLonLat(portFeature.getGeometry().getCoordinates());
  const s=ol.proj.toLonLat(starFeature.getGeometry().getCoordinates());
  const dist=pointToSegmentDistance(latestState.position,p,s);
  const speed=latestState.speed; let tLine=null;
  if(speed>0) tLine=dist/speed;
  let diff=null; if(tLine!==null) diff=tLine-timer.remainingSeconds;
  info.innerText=`Dist: ${dist.toFixed(1)} m | Tiempo línea: ${tLine?formatSec(tLine):'--'} | Δ cuenta: ${diff!==null?formatSec(diff):'--'}`;
}
function formatSec(s){ const sign=s<0?'-':''; s=Math.abs(Math.round(s)); const mm=Math.floor(s/60), ss=s%60; return `${sign}${mm}m${String(ss).padStart(2,'0')}s`; }
setInterval(computeAndUpdate,900);

// --- Timer ---
const timer={ remainingSeconds:0, running:false, interval:null };
function startTimer(){ if(!timer.running){ if(timer.remainingSeconds<=0) resetTimer(); timer.running=true; timer.interval=setInterval(()=>{ if(timer.remainingSeconds>0){ timer.remainingSeconds--; updateTimerDisplay(); } else {clearInterval(timer.interval); timer.running=false;} },1000);} }
function pauseTimer(){ if(timer.running){ clearInterval(timer.interval); timer.running=false; } }
function resetTimer(){ pauseTimer(); timer.remainingSeconds=Math.round((parseFloat(document.getElementById('countMin').value)||0)*60); updateTimerDisplay(); }
function updateTimerDisplay(){ const d=timer.remainingSeconds; const mm=Math.floor(d/60), ss=d%60; document.getElementById('timerDisplay').innerText=`${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
document.getElementById('startTimer').onclick=startTimer;
document.getElementById('pauseTimer').onclick=pauseTimer;
document.getElementById('resetTimer').onclick=resetTimer;
resetTimer();
</script>
</body>
</html>
