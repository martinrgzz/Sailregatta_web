<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SailRegatta Web</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.4.0/ol.css">
<style>
  html, body, #map { height: 100%; margin:0; }
  #map { position: fixed; inset:0; }
  .topbar{
    position:fixed; top:8px; left:50%; transform:translateX(-50%);
    background:rgba(30,30,30,0.7); color:#fff; padding:6px 12px;
    border-radius:12px; font-family:Arial; display:flex; gap:8px;
    align-items:center; z-index:2000; backdrop-filter:blur(6px);}
  .side-btn{
    position:fixed; top:50%; transform:translateY(-50%);
    background:rgba(30,30,30,0.7); color:#fff; padding:10px 14px;
    border-radius:12px; font-family:Arial; z-index:2000; border:none; cursor:pointer }
  #leftBtn{ left:10px } #rightBtn{ right:10px }
  #nightBtn{ position:fixed; top:8px; right:10px; background:rgba(30,30,30,0.7); color:#fff; padding:6px 12px; border-radius:8px; cursor:pointer; z-index:2000; }
  #info{
    position:fixed; bottom:8px; left:50%; transform:translateX(-50%);
    background:rgba(30,30,30,0.8); color:#fff; padding:8px 14px;
    border-radius:12px; z-index:2000; font-family:Arial; font-size:14px; backdrop-filter:blur(6px);}
  .context{
    position:fixed; background:#fff; border:1px solid #ccc; padding:6px;
    border-radius:6px; z-index:3000; font-family:Arial }
  #gpsError{
    position:fixed; bottom:50px; left:50%; transform:translateX(-50%);
    background:rgba(200,0,0,0.8); color:#fff; padding:6px 10px;
    border-radius:8px; font-family:Arial; display:none; z-index:4000; }
  button{ cursor:pointer; border:none; border-radius:6px; padding:4px 8px; }
</style>
</head>
<body>
<div id="map"></div>
<div class="topbar">
  <label>Cuenta atrás (min): <input id="countMin" type="number" value="5" min="0" step="1" style="width:60px"></label>
  <button id="startTimer">Iniciar</button>
  <button id="pauseTimer">Pausar</button>
  <button id="resetTimer">Reiniciar</button>
  <div id="timerDisplay" style="min-width:80px; text-align:center; font-weight:600;">00:00</div>
</div>
<button id="leftBtn" class="side-btn">Babor</button>
<button id="rightBtn" class="side-btn">Estribor</button>
<button id="nightBtn">Modo Noche</button>
<div id="info">Dist: -- m | Tiempo línea: -- | Δ cuenta: --</div>
<div id="gpsError">⚠️ No se pudo acceder al GPS</div>

<script src="https://cdn.jsdelivr.net/npm/ol@v7.4.0/dist/ol.js"></script>
<script>
// --- Mapas ---
const dayLayer = new ol.layer.Tile({ source: new ol.source.XYZ({ url:'https://cartodb-basemaps-a.global.ssl.fastly.net/rastertiles/voyager/{z}/{x}/{y}.png' }) });
const nightLayer = new ol.layer.Tile({ source: new ol.source.XYZ({ url:'https://cartodb-basemaps-a.global.ssl.fastly.net/rastertiles/dark_all/{z}/{x}/{y}.png' }), visible:false });

const map = new ol.Map({
  target:'map',
  layers:[dayLayer, nightLayer],
  view:new ol.View({ center: ol.proj.fromLonLat([0,0]), zoom:3 })
});

// --- Vectors ---
const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({ source: vectorSource });
map.addLayer(vectorLayer);

// --- Styles ---
const shipStyle = new ol.style.Style({ image: new ol.style.Icon({
  src: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzNiIgaGVpZ2h0PSIzNiIgdmlld0JveD0iMCAwIDI0IDI0Ij48cGF0aCBmaWxsPSIjMGI1IiBkPSJNMTIgMmwzIDdoLTZ6Ii8+PHBhdGggZmlsbD0iIzA2NCIgZD0iTTUgMTJoMTRsLTEgNkg2bC0xLTZ6Ii8+PC9zdmc+',
  scale:1.2, rotateWithView:true }) });
const portStyle = new ol.style.Style({ image: new ol.style.Circle({ radius:8, fill:new ol.style.Fill({color:'#ff4d4d'}), stroke:new ol.style.Stroke({color:'#fff', width:2}) }) });
const starStyle = new ol.style.Style({ image: new ol.style.Circle({ radius:8, fill:new ol.style.Fill({color:'#4da6ff'}), stroke:new ol.style.Stroke({color:'#fff', width:2}) }) });
const lineStyle = new ol.style.Style({ stroke: new ol.style.Stroke({ color:'#ffbf00', width:4 }) });

let shipFeature=null, portFeature=null, starFeature=null, lineFeature=null;

// --- Barco ---
function setShip(lonlat, headingDeg){
  const offsetM = 11;
  let finalLonLat=lonlat;
  if(!isNaN(headingDeg)){
    const theta=headingDeg*Math.PI/180;
    const dx=offsetM*Math.sin(theta);
    const dy=offsetM*Math.cos(theta);
    const XY=[lonToX(lonlat[0])+dx, latToY(lonlat[1])+dy];
    finalLonLat=[XY[0], XY[1]]; // usar coordenadas mercator
    finalLonLat=lonLatFromXY(XY);
  }
  if(!shipFeature){
    shipFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(finalLonLat)));
    shipFeature.setStyle(shipStyle); vectorSource.addFeature(shipFeature);
  } else {
    shipFeature.getGeometry().setCoordinates(ol.proj.fromLonLat(finalLonLat));
  }
}

// --- Marcas ---
function addPort(lonlat){ if(portFeature) return; portFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(lonlat)));
  portFeature.setStyle(portStyle); vectorSource.addFeature(portFeature); drawLineIfReady(); }
function addStar(lonlat){ if(starFeature) return; starFeature=new ol.Feature(new ol.geom.Point(ol.proj.fromLonLat(lonlat)));
  starFeature.setStyle(starStyle); vectorSource.addFeature(starFeature); drawLineIfReady(); }
function drawLineIfReady(){ if(portFeature && starFeature){
  if(lineFeature) vectorSource.removeFeature(lineFeature);
  lineFeature=new ol.Feature(new ol.geom.LineString([portFeature.getGeometry().getCoordinates(), starFeature.getGeometry().getCoordinates()]));
  lineFeature.setStyle(lineStyle); vectorSource.addFeature(lineFeature);
}}

// --- Long press ---
let pressTimer=null, pressCoord=null;
map.getViewport().addEventListener('pointerdown', e=>{
  pressTimer=setTimeout(()=>{ pressCoord=map.getEventCoordinate(e); showContext(e.clientX,e.clientY); }, 600);
});
map.getViewport().addEventListener('pointerup', ()=>{ if(pressTimer){clearTimeout(pressTimer); pressTimer=null;} });
function showContext(x,y){
  const feature = map.forEachFeatureAtPixel([x,y], f=>f);
  const menu=document.createElement('div'); menu.className='context'; menu.style.left=x+'px'; menu.style.top=y+'px';
  if(feature===portFeature||feature===starFeature){
    menu.innerHTML='<div style="font-weight:600;margin-bottom:6px">Marca</div><button id="ctxDel">Borrar</button><div style="height:6px"></div><button id="ctxClose">Cerrar</button>';
    document.body.appendChild(menu);
    document.getElementById('ctxDel').onclick=()=>{
      vectorSource.removeFeature(feature);
      if(feature===portFeature) portFeature=null; else starFeature=null;
      if(lineFeature) vectorSource.removeFeature(lineFeature); lineFeature=null;
      menu.remove();
    };
  } else {
    menu.innerHTML='<div style="font-weight:600;margin-bottom:6px">Poner marca</div><button id="ctxPort">Babor</button> <button id="ctxStar">Estribor</button><div style="height:6px"></div><button id="ctxClose">Cerrar</button>';
    document.body.appendChild(menu);
    document.getElementById('ctxPort').onclick=()=>{ addPort(ol.proj.toLonLat(pressCoord)); menu.remove(); };
    document.getElementById('ctxStar').onclick=()=>{ addStar(ol.proj.toLonLat(pressCoord)); menu.remove(); };
  }
  document.getElementById('ctxClose').onclick=()=>menu.remove();
}

// --- Botones coords ---
document.getElementById('leftBtn').onclick=()=>{ const lat=parseFloat(prompt('Latitud (dec):')), lon=parseFloat(prompt('Longitud (dec):')); if(!isNaN(lat)&&!isNaN(lon)) addPort([lon,lat]); };
document.getElementById('rightBtn').onclick=()=>{ const lat=parseFloat(prompt('Latitud (dec):')), lon=parseFloat(prompt('Longitud (dec):')); if(!isNaN(lat)&&!isNaN(lon)) addStar([lon,lat]); };

// --- Modo noche ---
document.getElementById('nightBtn').onclick=()=>{ nightLayer.setVisible(!nightLayer.getVisible()); dayLayer.setVisible(!nightLayer.getVisible()); };

// --- Geolocalización ---
let latestState={ position:null, speed:null, initialCentered:false };
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    document.getElementById('gpsError').style.display="none";
    const lonlat=[pos.coords.longitude,pos.coords.latitude];
    const heading = (pos.coords.heading!==null)?pos.coords.heading:0;
    setShip(lonlat, heading);
    latestState.position=lonlat;
    latestState.speed=pos.coords.speed;
    if(!latestState.initialCentered){ map.getView().animate({ center: ol.proj.fromLonLat(lonlat), zoom:15, duration:800 }); latestState.initialCentered=true; }
  }, ()=>{ document.getElementById('gpsError').style.display="block"; }, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
} else { document.getElementById('gpsError').style.display="block"; }

// --- Distancias y tiempo ---
function computeAndUpdate(){
  const info=document.getElementById('info');
  if(!latestState.position||!portFeature||!starFeature){ info.innerText='Dist: -- m | Tiempo línea: -- | Δ cuenta: --'; return; }
  const p=ol.proj.toLonLat(portFeature.getGeometry().getCoordinates());
  const s=ol.proj.toLonLat(starFeature.getGeometry().getCoordinates());
  const dist=pointToSegmentDistance(latestState.position,p,s);
  const speed=latestState.speed; let tLine=null;
  if(speed>0) tLine=dist/speed;
  let diff=null; if(tLine!==null) diff=tLine-timer.remainingSeconds;
  info.innerText=`Dist: ${dist.toFixed(1)} m | Tiempo línea: ${tLine?formatSec(tLine):'--'} | Δ cuenta: ${diff!==null?formatSec(diff):'--'}`;
}
function formatSec(s){ const sign=s<0?'-':''; s=Math.abs(Math.round(s)); const mm=Math.floor(s/60), ss=s%60; return `${sign}${mm}m${String(ss).padStart(2,'0')}s`; }
setInterval(computeAndUpdate,900);

// --- Timer ---
const timer={ remainingSeconds:0, running:false, interval:null };
function startTimer(){ if(!timer.running){ if(timer.remainingSeconds<=0) resetTimer(); timer.running=true; timer.interval=setInterval(()=>{ if(timer.remainingSeconds>0){ timer.remainingSeconds--; updateTimerDisplay(); } else {clearInterval(timer.interval); timer.running=false;} },1000);} }
function pauseTimer(){ if(timer.running){ clearInterval(timer.interval); timer.running=false; } }
function resetTimer(){ pauseTimer(); timer.remainingSeconds=Math.round((parseFloat(document.getElementById('countMin').value)||0)*60); updateTimerDisplay(); }
function updateTimerDisplay(){ const d=timer.remainingSeconds; const mm=Math.floor(d/60), ss=d%60; document.getElementById('timerDisplay').innerText=`${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
document.getElementById('startTimer').onclick=startTimer;
document.getElementById('pauseTimer').onclick=pauseTimer;
document.getElementById('resetTimer').onclick=resetTimer;
resetTimer();

window.addEventListener('beforeunload',()=>{});
</script>
</body>
</html>
